# **OSeMOSYS-LAC Execution Manual**

> Step-by-step guide to prepare inputs, run **clewsy**, and consolidate the regional model with **TransMoSYS**. All examples use the `$HOME` environment variable, so the instructions remain independent of the machine’s user name.

---

## 1. Prerequisites

| Requirement | Minimum version | Notes |
|-------------|-----------------|-------|
| macOS / Linux | 12.0 | Any POSIX system; paths are shown in POSIX style. |
| **conda** | 23.3 | Provides the `osemosys-global` environment. |
| Python | 3.10 | Included in the conda environment. |
| Git | 2.40 | For cloning and updating repositories. |
| **snakemake** | 8.0 | Installed inside the environment. |
| **clewsy** | *LAC branch* | Must contain the `clewsy.py` script. |

> **Path convention**  
> Replace the scenario folder name (e.g. `05272025`) as required.

---

## 2. Folder structure

```text
$HOME/GitHub/
├── osemosys_global/
│   ├── config/config.yaml      # Active configuration file
│   └── results/
│       └── scenario/
│           └── data/           # CSV inputs generated by Snakemake
├── OSeMOSYS-LAC/
│   ├── CLEWS-LAC.yaml          # clewsy configuration
│   ├── TransMoSYS.py           # Regional translator
│   └── data/                   # (to be created) clewsy output ➜ TransMoSYS
└── clewsy/
    └── src/build/clewsy.py
```

---

## 3. Detailed workflow

### 3.1 Clean previous results
```bash
rm -rf "$HOME/GitHub/osemosys_global/results/*"
```

### 3.2 Copy `config.yaml`
```bash
cp "$HOME/GitHub/OSeMOSYS-LAC/config.yaml"    "$HOME/GitHub/osemosys_global/config/config.yaml"
```

### 3.3 Activate the conda environment
```bash
conda activate osemosys-global
```

### 3.4 Generate base CSV files with **Snakemake**
```bash
cd "$HOME/GitHub/osemosys_global"
snakemake generate_input_data -j6
```
CSV files are created in `results/<scenario>/data/`, where `<scenario>` is taken from the `scenarioName` field in `config.yaml`.

### 3.5 Prepare **clewsy**
1. Rename the header `FUEL` to `COMMODITY` in:
   ```
   $HOME/GitHub/osemosys_global/results/05272025/data/FUEL.csv
   ```
2. Edit absolute paths in `CLEWS-LAC.yaml`:
   ```yaml
   DataDirectoryName: "$HOME/GitHub/osemosys_global/results/05272025/data"
   OsemosysGlobalPath: "$HOME/GitHub/osemosys_global/results/05272025/data"
   ```
3. Copy the updated `clewsy.py` into the official repository and make it executable:
   ```bash
   cp "$HOME/GitHub/OSeMOSYS-LAC/clewsy.py"       "$HOME/GitHub/clewsy/src/build/"
   chmod a+x "$HOME/GitHub/clewsy/src/build/clewsy.py"
   ```

### 3.6 Run **clewsy**
```bash
cd "$HOME/GitHub/clewsy"
./src/build/clewsy.py "$HOME/GitHub/OSeMOSYS-LAC/CLEWS-LAC.yaml"
```
When prompted, type **`Y`** (uppercase).

*Output*: `clewsy` creates a `data-out/` folder. Copy it to the LAC project and rename it to `data`:
```bash
cp -R data-out "$HOME/GitHub/OSeMOSYS-LAC/data"
```

### 3.7 Run **TransMoSYS**
```bash
cd "$HOME/GitHub/OSeMOSYS-LAC"
python TransMoSYS.py
```
Verify that `SpecifiedAnnualDemand.csv` and `TotalAnnualMaxCapacity.csv` are overwritten by the files generated by **TransMoSYS**.

### 3.8 Synchronise `data` with *osemosys_global*
```bash
rsync -av --delete "$HOME/GitHub/OSeMOSYS-LAC/data/"       "$HOME/GitHub/osemosys_global/results/05272025/data/"
```

### 3.9 Run the final model
```bash
cd "$HOME/GitHub/osemosys_global"
snakemake -j6
```

---

## 4. Troubleshooting

| Message | Likely cause | Recommended action |
|---------|--------------|--------------------|
| `FutureWarning: ... concatenation with empty or all-NA entries` | `TransMoSYS.py` concatenates an empty DataFrame. | Filter empty DataFrames or define the initial structure with fixed dtypes. |
| `FileNotFoundError` in clewsy | Incorrect paths in `CLEWS-LAC.yaml`. | Ensure absolute paths use `$HOME` and files exist. |
| `Permission denied` when executing `clewsy.py` | Lacking execute permission. | `chmod a+x clewsy.py` |
| Snakemake cannot find the rule `generate_input_data` | Wrong branch or changes in the `Snakefile`. | Update the `osemosys_global` repo and check the rules. |

---

## 5. References

* **OSeMOSYS-Global** – <https://github.com/OSeMOSYS/osemosys_global>
* **clewsy** – <https://github.com/OSeMOSYS/clewsy>
* **TransMoSYS** – Regional translator (included in this repo)

---

> Document version 1.2 – Updated 27 May 2025
